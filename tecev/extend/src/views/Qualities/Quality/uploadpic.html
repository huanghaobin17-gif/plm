<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <include file="Public:layerHeader"/>
</head>
<style>
    .layui-elem-quote {
        margin: 0px;
        padding: 10px;
        font-weight: bold
    }

    .layui-table {
        margin-top: 0px;
    }

    .layui-table img {
        cursor: pointer;
        max-width: 95% !important;
    }

    .media {
        margin: 0 auto;
    }

    #paizhao {
        float: right;
        font-size: 12px;
        font-weight: normal;
        color: #0a8ddf;
        cursor: pointer;
        vertical-align: middle;
    }

    .qrcode {
        display: none;
        width: 190px;
        height: 255px;
        padding: 20px 14px;
        box-sizing: border-box;
        position: absolute;
        background: url('/Public/images/qrcode.png') no-repeat;
        background-size: 188px 220px;
        right: 20px;
        top: 50px;
        z-index: 30;
    }

    .qrcode img {
        width: 100%;
    }

    .qrcode .tip {
        width: 170px;
        text-align: center;
        vertical-align: top;
        display: block;
        font-size: 14px;
        color: #333;
    }

    /*.fileDiv{*/
    /*float: right;*/
    /*position: relative;*/
    /*}*/
    #addAssetsFile {
        float: right;
        font-size: 12px;
        font-weight: normal;
        color: #0a8ddf;
        cursor: pointer !important;
        margin-right: 10px;
    }

    /*#fileinp {*/
    /*width: 66px;*/
    /*cursor: pointer!important;*/
    /*position: absolute;*/
    /*left: 0;*/
    /*top: 0;*/
    /*opacity: 0;*/
    /*}*/


</style>
<body>
<div class="containDiv">
    <div class="layui-elem-quote">
        相关文件
        <?php if($menuData = get_menu('Qualities','Quality','setQualityDetail')):?>
        <span id="paizhao"><i class="layui-icon layui-icon-zqrcode-l" style="font-size: 13px;"></i>
                            扫码上传
                            <div class="qrcode">
                                <img src="{$codeUrl}" alt="扫码上传">
                                <span class="tip">扫一扫，上传文件</span>
                            </div>
                        </span>
        <input type="file" id="fileElem" multiple accept="image/*" style="display:none">
        <span id="addAssetsFile" data-url="{$menuData['actionurl']}"><i class="iconfont icon-shangchuan" style="font-size: 14px;"></i> 本地上传 </span>
        <?php endif?>
    </div>
    <table class="layui-table" lay-even>
        <tbody>
        <empty name="report">
            <tr class="pic_content" style="display: none;">
                <th style="width: 50px;">
                    文件
                    <div class="del_pic" style="color: #0a8ddf;cursor: pointer;">删除</div>
                </th>
                <td class="td-align-center">
                    <img src="" class="bigImg">
                </td>
            </tr>
            <else />
            <tr class="pic_content">
                <th style="width: 50px;">
                    文件
                    <div class="del_pic" style="color: #0a8ddf;cursor: pointer;">删除</div>
                </th>
                <td class="td-align-center">
                    <img src="{$report}" class="bigImg">
                </td>
            </tr>
        </empty>
        </tbody>
    </table>
    <input type="hidden" name="qsid" value="{$qsid}"/>
</div>
<script src="__PUBLIC__/js/pdf.js?v={:mt_rand(1,54561)}"></script>
<script>
    layui.use(['form', 'upload'], function () {
        var form = layui.form, upload = layui.upload;
        $('a.media').media({width: 800, height: 600});
        var qsid = $('input[name="qsid"]').val();
        //上传附件


        var addAssetsFileObj = $('#addAssetsFile'), addAssetsFile = addAssetsFileObj[0];
        var fileElemObj = $('#fileElem'), fileElem = fileElemObj[0];
        addAssetsFile.addEventListener("click", function (e) {
            if (fileElem) {
                fileElem.click();
            }
            e.preventDefault(); // prevent navigation to "#"
        }, false);


        fileElemObj.change(function () {
            var v = $(this).val();
            var reader = new FileReader();
            reader.readAsDataURL(this.files[0]);
            var type = this.files[0].type;
            if (type.indexOf("image") == -1 ) {
                layer.msg('请上传图片');
                return false;
            }
            console.log(addAssetsFileObj.attr('data-url'));
            reader.onload = function (e) {
                var params = {};
                params.base64 = e.target.result;
                params.action = "upload";
                params.qsid = qsid;
                $.ajax({
                    timeout: 5000,
                    type: "POST",
                    url: addAssetsFileObj.attr('data-url'),
                    data: params,
                    dataType: "json",
                    async: true,
                    beforeSend: beforeSend,
                    success: function (res) {
                        if (res.status === 1) {
                            layer.msg(res.msg, {icon: 1, time: 1000}, function () {
                                $('.bigImg').attr('src', res.path);
                                $('.pic_content').show();
                            });
                        } else {
                            layer.msg(res.msg, {icon: 2}, 1000);
                        }
                    },
                    error: function () {
                        layer.msg("网络访问失败", {icon: 2}, 1000);
                    },
                    complete: complete
                });

            };
        });

        var paizhaoObj = $('#paizhao');
        paizhaoObj.on('mouseover', function () {
            $('.qrcode').show();
        });
        paizhaoObj.on('mouseout', function () {
            $('.qrcode').hide();
        });
        $(document).on('click', '.del_pic', function () {
            var params = {};
            params.action = 'del_file';
            params.qsid = $('input[name="qsid"]').val();
            $.ajax({
                timeout: 5000,
                type: "POST",
                url: $(this).attr('data-url'),
                data: params,
                dataType: "json",
                async: true,
                beforeSend: beforeSend,
                success: function (data) {
                    if (data.status == 1) {
                        layer.msg(data.msg, {icon: 1, time: 1000}, function () {
                            $('.pic_content').html('');
                            var new_td = '<th style="width: 50px;">\n' +
                                '                    文件\n' +
                                '                    <div class="del_pic" style="color: #0a8ddf;cursor: pointer;">删除</div>\n' +
                                '                </th>\n' +
                                '                <td class="td-align-center">\n' +
                                '                    <img src="" class="bigImg">\n' +
                                '                </td>';
                            $('.pic_content').html(new_td);
                            $('.pic_content').hide();
                        });
                    } else {
                        layer.msg(data.msg, {icon: 2}, 1000);
                    }
                },
                error: function () {
                    layer.msg("网络访问失败", {icon: 2}, 1000);
                },
                complete: complete
            });
        });
    });

    $(".bigImg").click(function () {
        var imgUrl = $(this).attr('src');
        window.img_width = 355;
        var html = "<center>";
        html += "<div style='position:fixed; left:50%; margin-left:-40px; bottom:5px;'>";
        html += "  <button style='width:40px; height:40px; border-radius:20px;'";
        html += "        onclick='window.img_width < 1000 ? window.img_width += 100 : 0;";
        html += "  $(\".img_url_class\").css({width: window.img_width});'>";
        html += "  放大";
        html += "  </button>&nbsp; &nbsp; ";
        html += "  <button style='width:40px;  height:40px;border-radius:20px;'";
        html += "  onclick='window.img_width > 100 ? window.img_width -= 100 : 0;";
        html += "  $(\".img_url_class\").css({width: window.img_width})' >";
        html += "  缩小";
        html += "  </button>";
        html += "</div>";
        html += "</center>";
        html += "<br/>";
        html += "<center>";
        html += "<img class='img_url_class' style='width:100%;' src='" + imgUrl + "' />";
        html += "</center>";
        //页面层
        layer.open({
            title: '原始图缩放浏览',
            type: 1,
            anim: 2,
            shadeClose: true,
            area: ['75%', '100%'], //宽高
            content: html
        });
    });

    //    下载word文档
    $(".downFile").click(function () {
        var path = $(this).attr('data-path');
        window.location.href = admin_name+'/Scrap/showFile?path=' + path + '&type=downFile';
        return false;
    })

</script>
</body>
</html>