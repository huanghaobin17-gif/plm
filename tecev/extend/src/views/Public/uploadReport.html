<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <include file="Public:layerHeader"/>
</head>
<style>
    #LAY-Public-uploadReport .layui-elem-quote {
        margin: 0;
        padding: 10px;
        font-weight: bold
    }

    #LAY-Public-uploadReport .layui-table {
        margin-top: 0;
    }

    #LAY-Public-uploadReport .layui-table img {
        cursor: pointer;
        max-width: 500px !important;
        max-height: 500px !important;
    }

    #LAY-Public-uploadReport .media {
        margin: 0 auto;
        max-width: 500px !important;
        max-height: 500px !important;
    }
    #LAY-Public-uploadReport .media iframe{
        max-width: 500px !important;
        max-height: 500px !important;
    }

    #LAY-Public-uploadReport #addReportFile {
        float: right;
        font-size: 12px;
        font-weight: normal;
        color: #0a8ddf;
        cursor: pointer;
        margin-right: 10px;
    }

    #LAY-Public-uploadReport #paizhao {
        float: right;
        font-size: 12px;
        font-weight: normal;
        color: #0a8ddf;
        cursor: pointer;
        vertical-align: middle;
    }

    #LAY-Public-uploadReport .qrcode {
        display: none;
        width: 190px;
        height: 255px;
        padding: 20px 14px;
        box-sizing: border-box;
        position: absolute;
        background: url('/Public/images/qrcode.png') no-repeat;
        background-size: 188px 220px;
        right: 20px;
        top: 50px;
        z-index: 30;
    }

    #LAY-Public-uploadReport .qrcode img {
        width: 100%;
    }

    #LAY-Public-uploadReport .qrcode .tip {
        width: 170px;
        text-align: center;
        vertical-align: top;
        display: block;
        font-size: 14px;
        color: #333;
    }
</style>
<body>
<div class="containDiv" id="LAY-Public-uploadReport">
    <div class="layui-elem-quote">
        相关文件
        <span id="paizhao">
            <i class="layui-icon layui-icon-zqrcode-l" style="font-size: 13px;"></i>
            扫码上传
            <div class="qrcode">
                <img src="{$codeUrl}" alt="扫码上传">
                <span class="tip">扫一扫，上传文件</span>
            </div>
        </span>
        <span id="addReportFile"><i class="iconfont icon-shangchuan" style="font-size: 14px;"></i> 本地上传 </span>
    </div>
    <table class="layui-table" lay-even>
        <colgroup>
            <col width="60">
            <col width="120">
            <col width="">
            <col width="100">
        </colgroup>
        <tbody>
        <tr>
            <th>序号</th>
            <th>文件名称</th>
            <th style="text-align: center">内容</th>
            <th>操作</th>
        </tr>
        <volist name="uploadinfo" id="vo">
            <tr>
                <td>{$key+1}</td>
                <td>{$vo.file_name}</td>
                <td class="td-align-center">
                    <switch name="vo.type">
                        <case value="1">
                            <img src="{$vo.file_url}" class="bigImg">
                        </case>
                        <case value="2">
                            <a class="media" href="{$vo.file_url}"></a>
                        </case>
                        <case value="3">
                            <span class="rquireCoin">word文档暂不支持预览</span>
                        </case>
                    </switch>
                </td>
                <td>
                    <div class="layui-btn-group">
                    <button class="layui-btn layui-btn-xs layui-btn-normal downFile" data-path="{$vo.file_url}" data-name="{$vo.file_name}">下载</button>
                    <button class="layui-btn layui-btn-xs layui-btn-danger del_file" data-id="{$vo.file_id}">删除</button>
                    </div>
                </td>
            </tr>
        </volist>
        </tbody>
    </table>
    <input type="hidden" name="id" value="{$id}"/>
    <input type="hidden" name="idName" value="{$idName}"/>
    <input type="hidden" name="uploadAction" value="{$uploadAction}"/>
</div>
<script src="__PUBLIC__/js/pdf.js?v={:mt_rand(1,54561)}"></script>
<script>
    layui.use(['form', 'upload'], function () {
        var thisbody=$('#LAY-Public-uploadReport');
        var url=thisbody.find('input[name="uploadAction"]').val();
        var upload = layui.upload;
        thisbody.find('a.media').media({width: 500, height: 400});
        var id = thisbody.find('input[name="id"]').val();
        var idName = thisbody.find('input[name="idName"]').val();
        //上传附件

        uploadFile = upload.render({
            elem: '#addReportFile'  //绑定元素
            , url: url //接口
            , accept: 'file'
            , exts: 'jpg|png|bmp|jpeg|doc|docx|pdf' //格式 用|分隔
            , method: 'POST'
            , data: {'action': 'uploadReport', 'id': id,'idName':idName}
            , done: function (res) {
                layer.closeAll('loading');
                if (res.status === 1) {
                    layer.msg(res.msg, {icon: 1, time: 1000}, function () {
                        location.reload();
                    });
                } else {
                    layer.msg(res.msg, {icon: 2}, 1000);
                }
            }
            , error: function () {
                //失败
                layer.msg('上传失败', {icon: 2}, 1000);
            }
        });
        thisbody.find('#paizhao').on('mouseover', function () {
            $('.qrcode').show();
        });
        thisbody.find('#paizhao').on('mouseout', function () {
            $('.qrcode').hide();
        });
        $('.del_file').on('click', function () {
            var target = $(this);
            layer.confirm('是否删除？', {icon: 3, title: '移除提示'}, function () {
                var params = {};
                params.action = 'deleteFile';
                params.file_id = target.attr('data-id');
                $.ajax({
                    timeout: 5000,
                    type: "POST",
                    url: url,
                    data: params,
                    dataType: "json",
                    async: true,
                    beforeSend: beforeSend,
                    success: function (data) {
                        if (data.status === 1) {
                            layer.msg(data.msg, {icon: 1, time: 1000}, function () {
                                target.parent().parent().parent().remove();
                            });
                        } else {
                            layer.msg(data.msg, {icon: 2}, 1000);
                        }
                    },
                    error: function () {
                        layer.msg("网络访问失败", {icon: 2}, 1000);
                    },
                    complete: complete
                });
            });
        });
    });

    $(".bigImg").click(function () {
        var imgUrl = $(this).attr('src');
        window.img_width = 355;
        var html = "<center>";
        html += "<div style='position:fixed; left:50%; margin-left:-40px; bottom:5px;'>";
        html += "  <button style='width:40px; height:40px; border-radius:20px;'";
        html += "        onclick='window.img_width < 1000 ? window.img_width += 100 : 0;";
        html += "  $(\".img_url_class\").css({width: window.img_width});'>";
        html += "  放大";
        html += "  </button>&nbsp; &nbsp; ";
        html += "  <button style='width:40px;  height:40px;border-radius:20px;'";
        html += "  onclick='window.img_width > 100 ? window.img_width -= 100 : 0;";
        html += "  $(\".img_url_class\").css({width: window.img_width})' >";
        html += "  缩小";
        html += "  </button>";
        html += "</div>";
        html += "</center>";
        html += "<br/>";
        html += "<center>";
        html += "<img class='img_url_class' style='width:100%;' src='" + imgUrl + "' />";
        html += "</center>";
        //页面层
        layer.open({
            title: '原始图缩放浏览',
            type: 1,
            anim: 2,
            shadeClose: true,
            area: ['75%', '100%'], //宽高
            content: html
        });
    });


    $(document).on('click','.downFile',function () {
        var params={};
        params.path= $(this).data('path');
        params.filename=$(this).data('name');
        postDownLoadFile({
            url:admin_name+'/Tool/downFile',
            data:params,
            method:'POST'
        });
        return false;
    });


</script>
</body>
</html>