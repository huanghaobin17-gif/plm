<include file="Public:head"/>
<style>
    .layui-card {
        box-shadow: none;
        margin: 0;
    }

    .writeInput {
        border: none;
        border-bottom: 1px solid #e5e5e5;
        width: 99%
    }

    .inconformityInput {
        margin-left: 5px;
        min-height: 0;
        padding-bottom: 10px;
    }

    .layui-card-header {
        border-bottom-color: #e5e5e5
    }

    .layui-form-radio {
        margin-left: 10px;
    }

    .enter {
        height: 60px;
        line-height: 60px;
        font-size: 30px;
        margin-top: 20px;
    }
    .divpic{
        display: none;
    }

    .faceDiv p {
        padding: 0 1rem;
        font-size: 1rem;
    }

    .faceDiv span {
        color: red;
    }

    .miniTitle {
        font-size: 0.85rem;
    }

    .layui-card-body {
        padding: 5px 10px !important
    }
</style>
<body>
<div class="layui-fluid">
    <div class="layui-row">
        <form class="layui-form">
            <div class="layui-card moveAnimatedDiv" style="margin-top: 0;">
                <div class="layui-card-header borderNone">
                    <h2 class="detailTitle">质控计划详情信息</h2>
                    <div class="bl1px"></div>
                </div>
                <table class="layui-table">
                    <tbody>
                    <tr>
                        <th>检测报告编号</th>
                        <td><span class="stroageNumber">{$qsInfo.plan_num}</span></td>
                    </tr>
                    <tr>
                        <th>质控计划名称</th>
                        <td>{$qsInfo.plan_name}</td>
                    </tr>
                    <tr>
                        <th>检测依据</th>
                        <td>{$qsInfo.basis}</td>
                    </tr>
                    <tr>
                        <th>检测仪器(标准器、模拟器)</th>
                        <td>{$qsInfo.instrument}</td>
                    </tr>
                    <tr>
                        <th>检测人</th>
                        <td>{$detailInfo.adduser}</td>
                    </tr>
                    <tr>
                        <th>检测时间</th>
                        <td>{$detailInfo.addtime}</td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <div class="layui-card moveAnimatedDiv">
                <div class="layui-card-header borderNone">
                    <h2 class="detailTitle">检测设备基础信息</h2>
                    <div class="bl1px"></div>
                </div>
                <table class="layui-table">
                    <tbody>
                    <tr>
                        <th>设备编号</th>
                        <td>{$asInfo.assnum}</td>
                    </tr>
                    <tr>
                        <th>设备名称</th>
                        <td>{$asInfo.assets}</td>
                    </tr>
                    <tr>
                        <th>规格/型号</th>
                        <td>{$asInfo.model}</td>
                    </tr>
                    <tr>
                        <th>使用科室</th>
                        <td>{$asInfo.department}</td>
                    </tr>
                    <tr>
                        <th>产品系列号</th>
                        <td>{$asInfo.serialnum}</td>
                    </tr>
                    <tr>
                        <th>品牌</th>
                        <td>{$asInfo.brand}</td>
                    </tr>
                    <tr>
                        <th>启用日期</th>
                        <td>{$asInfo.opendate}</td>
                    </tr>
                    <tr>
                        <th>上次质控时间</th>
                        <td>{$asInfo.lasttesttime}</td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <div class="layui-card moveAnimatedDiv">
                <div class="layui-card-header borderNone">
                    <h2 class="detailTitle">质控检测明细（模板：除颤仪）</h2>
                    <div class="bl1px"></div>
                </div>
                <div class="layui-card faceDiv">
                    <p>
                        外观功能：
                        <span>
                        <if condition="$detailInfo.exterior eq 1">
                            符合
                        </if>
                        <if condition="$detailInfo.exterior eq 2">
                            不符合
                        </if>
                        </span>
                    </p>
                    <if condition="$detailInfo.exterior eq 2">
                        <p>
                            不符合情况说明：
                            <span>{$detailInfo.exterior_explain}</span>
                        </p>
                    </if>
                </div>
                <div class="layui-card">
                    <div class="layui-card-body">
                        <table class="layui-table">
                            <thead>
                            <tr>
                                <th colspan="2" style="text-align: left;">心率（次/min）：最大允差：{$tolerance.heartRate}</th>
                            </tr>
                            </thead>
                            <tbody>
                            <volist name="setting.heartRate" id="vo">
                                <tr>
                                    <th style="width: 55%;">设定值：{$vo}</th>
                                    <td>测量值：{$detailInfo['preset_detection']['heartRate'][$key]}</td>
                                </tr>
                            </volist>
                            <tr>
                                <th>心率检测结果：</th>
                                <td>
                                    <if condition="$detail_result['heartRate'] eq 1">
                                        符合
                                        <elseif condition="$detail_result['heartRate'] eq 2"/>
                                        不符合
                                        <else/>
                                        未知
                                    </if>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="layui-card">
                    <div class="layui-card-body">
                        <table class="layui-table">
                            <thead>
                            <tr>
                                <th colspan="2" style="text-align: left;">释放能量（J）：最大允差：{$tolerance.energesis}</th>
                            </tr>
                            </thead>
                            <tbody>
                            <volist name="setting.energesis" id="vo">
                                <tr>
                                    <th style="width: 55%;">设定值：{$vo}</th>
                                    <td>
                                        <span style="width: 3.5rem;display: inline-block;text-align: right;">测量值：</span>{$detailInfo['preset_detection']['energesis'][$key]}
                                        <br>
                                        <span style="width: 3.4rem;display: inline-block;text-align: right;">误差：{$detailInfo['preset_detection']['energesis_tolerance'][$key]}</span>
                                    </td>
                                </tr>
                            </volist>
                            <tr>
                                <th>能量偏移情况判断：</th>
                                <td>
                                    <if condition="$detail_result['energesis'] eq 1">
                                        符合
                                        <elseif condition="$detail_result['energesis'] eq 2"/>
                                        不符合
                                        <else/>
                                        未知
                                    </if>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="layui-card">
                    <div class="layui-card-body">
                        <table class="layui-table">
                            <thead>
                            <tr>
                                <th colspan="2" style="text-align: left;">其他信息</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr>
                                <th style="width: 55%;">充电时间（s）：</th>
                                <td>{$detailInfo['preset_detection']['charge']}</td>
                            </tr>
                            <tr>
                                <th>充电时间情况判断：</th>
                                <td>
                                    <if condition="$detailInfo['preset_detection']['charge_result'] eq 1">
                                        正常
                                        <elseif condition="$detailInfo['preset_detection']['charge_result'] eq 2"/>
                                        不正常
                                        <else/>
                                        未知
                                    </if>
                                </td>
                            </tr>
                            <tr>
                                <th>内部放电情况判断：</th>
                                <td>
                                    <if condition="$detailInfo['fixed_detection']['internal_discharge'] eq 1">
                                        正常
                                        <elseif condition="$detailInfo['fixed_detection']['internal_discharge'] eq 2"/>
                                        不正常
                                        <else/>
                                        未知
                                    </if>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="layui-card">
                    <div class="layui-card faceDiv">
                        <p>
                            检测结果：
                        <span>
                        <if condition="$detailInfo.result eq 1">
                            合格
                            <else/>
                            不合格
                        </if>
                        </span>
                        </p>
                        <notempty name="detailInfo['remark']">
                            <p>
                                检测备注：
                                <span>{$detailInfo.remark}</span>
                            </p>
                        </notempty>
                    </div>
                </div>
            </div>
            <notempty name="file_data['nameplate']">
                <div class="layui-card">
                    <div class="layui-card-header">
                        <span style="float: left">设备铭牌照片</span>
                    </div>

                    <div class="layui-card-body">
                        <dl>
                            <dd>
                                <div class="swiper-container" id="uploadPhotoCarousel">
                                    <div class="swiper-wrapper nameplate_pic">
                                        <volist name="file_data['nameplate']" id="vo" key="k">
                                            <div class="swiper-slide photoDiv" div-index="{$k-1}">
                                                <img src="{$vo.file_url}" class="photo">
                                            </div>
                                        </volist>

                                    </div>
                                    <!-- 如果需要分页器 -->
                                    <div class="swiper-pagination"></div>
                                </div>
                            </dd>
                        </dl>
                    </div>
                </div>
            </notempty>
            <notempty name="file_data['instrument_view']">
                <div class="layui-card">
                    <div class="layui-card-header">
                        <span style="float: left">检测仪器视图照片</span>
                    </div>

                    <div class="layui-card-body">
                        <dl>
                            <dd>
                                <div class="swiper-container" id="checkPhotoCarousel">
                                    <div class="swiper-wrapper instrument_view_pic">
                                        <volist name="file_data['instrument_view']" id="vo" key="k">
                                            <div class="swiper-slide photoDiv" div-index="{$k-1}">
                                                <img src="{$vo.file_url}" class="photo">
                                            </div>
                                        </volist>
                                    </div>
                                    <!-- 如果需要分页器 -->
                                    <div class="swiper-pagination"></div>
                                </div>
                            </dd>
                        </dl>
                    </div>
                </div>
            </notempty>

            <div class="layui-card moveAnimatedDiv">
                <div id="divpic"
                <if condition="empty($detailInfo['report']) eq true">class="divpic"
                    <else/>
                </if>
                >
                <div class="layui-card-header">
                    <span style="float: left">质控报告</span>
                </div>
                <div class="layui-card-body">
                    <dl>
                        <dd>
                            <div class="swiper-container">
                                <div class="swiper-wrapper instrument_view_pic">
                                    <div class="swiper-slide">
                                        <img src="{$detailInfo.report}" id="img" class="photo">
                                    </div>
                                </div>
                                <!-- 如果需要分页器 -->
                                <div class="swiper-pagination"></div>
                            </div>
                        </dd>
                    </dl>
                </div>
            </div>
            <div class="layui-card moveAnimatedDiv">
                <div class="layui-card-body">
                    <input type="hidden" name="qsid" value="{$qsInfo.qsid}">
                    <div class="layui-btn" id="uploadFile" style="width: 100%;">上传质控报告</div>
                </div>

                <div class="layui-card-body">
                    <button class="layui-btn layui-btn-warm backButton " style="width: 100%;">返回</button>
                </div>
            </div>
        </form>
    </div>
</div>
</body>
</html>

<script>
    //    定义全局变量
    var resultData = {};
    layui.use(['form', 'element','upload'], function () {
        var form = layui.form, element = layui.element, upload = layui.upload, numberType = $("input[type='number']"),
                radioType = $("input[type='radio']");
        qsid = $("input[name='qsid']").val();

        numberType.each(function (k, v) {
            $(v).attr('readonly', true);
        });
        radioType.each(function (k, v) {
            $(v).attr('disabled', true);
        });
        $("input[type='radio']:checked").each(function (k, v) {
            $(v).attr('disabled', false)
        });
        $(".layui-colla-content").each(function (k, v) {
            $(v).addClass('layui-show')
        });
        form.render();
        var images = {};
        $('#uploadFile').on('click', function () {
            wx.chooseImage({
                count: 1, // 默认9
                sizeType: ['original', 'compressed'], // 可以指定是原图还是压缩图，默认二者都有
                sourceType: ['album', 'camera'], // 可以指定来源是相册还是相机，默认二者都有
                success: function (res) {
                    images.localId = res.localIds;//把图片的路径保存在images[localId]中--图片本地的id信息，用于上传图片到微信浏览器时使用
                    ulLoadToWechat(); //把这些图片上传到微信服务器  一张一张的上传
                }
            });
        });

        //上传图片到微信]
        function ulLoadToWechat() {
            length = images.localId.length; //本次要上传所有图片的数量
            for (var i = 0; i < length; i++) {
                (function (i) {
                    setTimeout(function () {
                        wx.uploadImage({
                            localId: images.localId[i], //图片在本地的id
                            success: function (res) {
                                images.serverId = res.serverId;
                                wxImgDown(res.serverId);
                            },
                            fail: function (res) {
                                layer.msg('服务器繁忙', {icon: 2});
                            }
                        });
                    }, i * 2000);
                })(i)
            }
        }

        function upimg(id) {

        }

        //下载上传到微信上的图片
        function wxImgDown(mid) {
            var params = {};
            params.mid = mid;
            params.action = 'upload';
            params.qsid = $("input[name='qsid']").val();
            $.ajax({   //后台下载
                type: "POST",
                url: "setQualityDetail",
                data: params,
                dataType: "json",
                async: true,
                success: function (data) {
                    if (data.status == 1) {
                        var path = data.path;
                        $('#divpic').show();
                        $('#img').attr('src', path);

                        layer.msg(data.msg, {icon: 1}, 1000);
                    } else {
                        layer.msg(data.msg, {icon: 2}, 1000);
                    }
                },
                erro: function () {
                    layer.msg('服务繁忙，请稍后再试！', {icon: 2});
                }
            });
        }
    });
    $(document).on('click', '.backButton', function () {
        window.history.go(-1);
        return false;
    });
</script>